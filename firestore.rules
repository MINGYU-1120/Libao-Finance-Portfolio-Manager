rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserRole() {
       let path = /databases/$(database)/documents/user_directory/$(request.auth.uid);
       return isSignedIn() && exists(path) ? get(path).data.role : 'viewer';
    }

    function getTier(role) {
      // Map roles to integer tiers
      return role == 'admin' ? 3 :
             role == 'vip' ? 2 :
             role == 'member' ? 1 : 0;
    }

    function hasRole(role) {
      return getUserRole() == role;
    }

    function isAdmin() {
      // 1. Identity-based Super Admin (Priority: Bootstrap safely even if DB doc doesn't exist)
      let isIdentityAdmin = isSignedIn() && (
        request.auth.token.email == '1033023@ntsu.edu.tw' || 
        request.auth.token.email == 'libao.finance@gmail.com'
      );

      // 2. Role-based Admin (Dynamic: Check DB role)
      return isIdentityAdmin || (isSignedIn() && getUserRole() == 'admin');
    }

    // --- Tier Based Access Helper ---
    function canAccessSection(sectionKey) {
       // 1. Get User's Tier (Defaults to 0 for new or signed-out users)
       let role = getUserRole();
       let userTier = getTier(role);

       // 2. Get Section's Min Tier from Config
       let configPath = /databases/$(database)/documents/config/permissions;
       let hasConfig = exists(configPath);
       let minTier = hasConfig && sectionKey in get(configPath).data 
                     ? get(configPath).data[sectionKey] : 0; 
       
       return userTier >= minTier;
    }

    // --- Rules ---

    // 1. Config: Only Admin can write access controls
    match /config/access_control {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    match /config/permissions {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // 2. User Directory: Restricted Access
    // FIX: Block public read to prevent email scraping (IDOR)
    // FIX: Block self-promotion to admin (Privilege Escalation)
    match /user_directory/{userId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      
      allow write: if isAdmin() || (isSignedIn() && request.auth.uid == userId && (
        // Case A: Creating new doc - Role must be 'viewer' unless Super Admin
        (resource == null && request.resource.data.role == 'viewer') ||
        // Case B: Updating doc - Role field must NOT change
        (resource != null && request.resource.data.role == resource.data.role) ||
        // Exception: Super Admins can write anything (including promoting themselves)
        isAdmin()
      ));
    }

    // 3. User Profiles: Owner can read/write their own
    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // 4. AI Picks: Tier Restricted
    match /ai_picks/{pickId} {
      // Read: Based on Tier for 'ai_picks' section
      allow read: if isSignedIn() && canAccessSection('ai_picks');
      // Write: Admin only
      allow write: if isAdmin();
    }

    // 5. Public Portfolios (Market Insider? Martingale?)
    // Assuming 'martingale' is stored here or similar
    match /public_portfolios/{docId} {
      // Allow based on section permission (STANDARD/Member by default)
      allow read: if isSignedIn() && canAccessSection('martingale');
      // Only Admin can write
      allow write: if request.auth != null && isAdmin();
    }

    // --- Protected Sections Rule (NEW) ---
    match /sections/{sectionId} {
      function getSectionAllowedRoles(id) {
        // In real app, fetch from /config/permissions
        // Here we hardcode for MVP security
        return id == 'market_insider' ? ['admin', 'member'] : ['admin', 'member', 'viewer'];
      }
      
      // Public metadata (Teaser info)
      match /public/{doc} {
        allow read: if true;
      }
      
      // Private content (Real Data)
      match /private/{doc} { 
        // Allow Admin to Read (View) and Write (Seed Data)
        allow read, write: if request.auth != null && hasRole('admin'); 
      }
    }

    // 6. Audit Logs: Admin Read/Write Only
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if isAdmin(); // In real app, only Cloud Functions should write this, but for MVP Admin Client writes it.
    }
  }
}
